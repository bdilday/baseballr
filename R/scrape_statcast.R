#' Query Statcast and PITCHf/x Data for data from baseballsavant.mlb.com
#'
#' This function allows you to query Statcast and PITCHf/x data as provided on baseballsavant.mlb.com and have that data returned as a dataframe.
#' @param start_date Date of first game for which you want data. Format must be in YYYY-MM-DD format.
#' @param end_date Date of last game for which you want data. Format must be in YYYY-MM-DD format.
#' @param playerid The MLBAM ID for the player who's data you want to query.
#' @param player_type The player type. Can be 'batter' or 'pitcher' 
#' @keywords MLB, sabermetrics, Statcast
#' @importFrom utils read.csv
#' @export
#' @examples
#' \dontrun{
#' scrape_statcast_savant(start_date = "2016-04-06", end_date = "2016-04-15", playerid = 621043, player_type='batter')
#' 
#' scrape_statcast_savant(start_date = "2016-04-06", end_date = "2016-04-15", playerid = 592789, player_type='pitcher')
#' 
#' scrape_statcast_savant(start_date = "2016-04-06", end_date = "2016-04-06")
#' }

scrape_statcast_savant <- function(start_date, end_date, playerid=NULL, player_type=NULL) {
  # Check to make sure args are in the correct format.
  if(!is.character(start_date) | !is.character(end_date)) {
    warning("Please wrap your dates in quotations in 'yyyy-mm-dd' format.")
    return(NULL)
  }
  # Check for other user errors.
  if(as.Date(start_date)<="2015-03-01") { # March 1, 2015 was the first date of Spring Training.
    message("Some metrics such as Exit Velocity and Batted Ball Events have only been compiled since 2015.")
  }
  if(as.Date(start_date)<="2008-03-25") { # March 25, 2008 was the first date of Spring Training.
    stop("The data are limited to the 2008 MLB season and after.")
    return(NULL)
  }
  if(as.Date(start_date)==Sys.Date()) {
    message("The data are collected daily at 3 a.m. Some of today's games may not be included.")
  }
  if(as.Date(start_date)>as.Date(end_date)) {
    stop("The start date is later than the end date.")
    return(NULL)
  }
  
  # extract season from start_date
  
  year <- substr(start_date, 1,4)

  # Base URL.
  url <- paste0(
    "https://baseballsavant.mlb.com/statcast_search/csv?all=true",
    "&hfPT=&hfAB=&hfBBT=&hfPR=&hfZ=&stadium=&hfBBL=&hfNewZones=&hfGT=R%7CPO%7CS%7C&hfC=",
    "&hfSea=", year, "%7C&hfSit=&hfOuts=&opponent=&pitcher_throws=",
    "&batter_stands=&hfSA=&",
    "game_date_gt=",start_date,"&game_date_lt=",end_date,
    "&team=",
    "&position=&hfRO=&home_road=&hfFlag=&metric_1=&hfInn=&min_pitches=0&min_results=0&",
    "group_by=name&sort_col=pitches&player_event_sort=h_launch_speed&sort_order=desc&min_abs=0&type=details")

  if (!is.null(playerid)) {
    url <- paste0(url, "&player_lookup%5B%5D=", playerid)
  }
  
  if(!is.null(player_type)) {
    url <- paste0(url, "&player_type=", player_type)
  } 

  if (!is.null(playerid) && is.null(player_type)) {
    warning("playerid id given without player_type. player_type will default to batter")
  }  
  
  # Do a try/catch to show errors that the user may encounter while downloading.
  tryCatch(
    {
      print("These data are from BaseballSevant and are property of MLB Advanced Media, L.P. All rights reserved.")
      print("Grabbing data, this may take a minute...")
      payload <- utils::read.csv(url)
      process_statcast_payload(payload)
    },
    error=function(cond) {
      message(paste("URL does not seem to exist, please check your Internet connection:"))
      message("Original error message:")
      message(cond)
      return(NA)
    },
    warning=function(cond) {
      message(paste("URL caused a warning. Make sure your playerid and date range are correct:"))
      message("Original warning message:")
      message(cond)
      return(NULL)
    }
  ) 
}

#' Process Baseball Savant CSV payload
#'
#' @param payload payload from a Baseball Savant request, e.g. from utils::read.csv 
#' @keywords MLB, sabermetrics, Statcast

process_statcast_payload <- function(payload) {
  
  # Clean up formatting.
  payload[payload=="null"] <- NA
  
  character_columns <- c("des", "home_team", "away_team",
                         "player_name", "events", "description", 
                         "hit_location", "sv_id", "pitch_name")
  
  character_columns <- c(character_columns, grep("^pos[0-9]_person_id", names(payload), value = TRUE))
  
  numeric_columns <- c(
    "game_pk",
    "on_1b",
    "on_2b",
    "on_3b",
    "release_pos_x",
    "release_pos_z",
    "release_pos_y",
    "pfx_x",
    "pfx_z",
    "hc_x",
    "hc_y",
    "woba_denom",
    "woba_value",
    "babip_value",
    "iso_value",
    "plate_z",
    "plate_x",
    "vx0",
    "vy0",
    "vz0",
    "ax",
    "ay",
    "az",
    "sz_top",
    "sz_bot",
    "hit_distance_sc",
    "launch_speed",
    "launch_speed_angle",
    "launch_angle",
    "estimated_ba_using_speedangle",
    "estimated_woba_using_speedangle",
    "effective_speed",
    "release_speed",
    "zone",
    "release_spin_rate",
    "release_extension",
    "home_score", "away_score",
    "bat_score", "fld_score",
    "post_away_score", "post_home_score",
    "post_bat_score", "post_fld_score"
    )
  
  payload$game_date <- as.Date(payload$game_date, "%Y-%m-%d")
  
  for (column_name in character_columns) {
    payload[[column_name]] <- as.character(payload[[column_name]])
  }

  for (column_name in numeric_columns) {
    payload[[column_name]] <- as.numeric(as.character(payload[[column_name]]))
  }

  payload$barrel <- with(payload, ifelse(launch_angle <= 50 & launch_speed >= 98 & launch_speed * 1.5 - launch_angle >= 117 & launch_speed + launch_angle >= 124, 1, 0))
 
  message("URL read and payload acquired successfully.")
  
  return(payload)
  
}